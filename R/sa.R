# sa.R - Status and trend estimators and indicators.
# mse/R/sa.R

# Copyright European Union, 2018-2021
# Author: Iago Mosqueira (EC JRC) <iago.mosqueira@ec.europa.eu>
#
# Distributed under the terms of the European Union Public Licence (EUPL) V.1.1.

# perfect.sa {{{


#' A perfect 'estimate' of abundances, catches and harvest.
#'
#' The *FLStock* generated by the call to *oem* is simply passed on in this
#' function. The estimates of abundance, catches and exploitation will thus be
#' as precise as the OEM observation.
#'
#' @param stk The stock observation generated by *oem*. Class *FLStock*.
#' @param idx An observation of chnages in abundance, not used. Class *FLIndices*.
#' @param args MSE arguments, class *list*.
#' @param tracking Structure for tracking modules outputs.
#'
#' @return A *list* with elements *stk* and *tracking*.
#'
#' @examples
#' data(sol274)
#' perfect.sa(stock(om), FLIndices(), args=list(ay=2018, dy=2017),
#'   tracking=FLQuants(FLQuant(dimnames=list(metric="conv.est", year=2018))))

perfect.sa <- function(stk, idx, args, tracking, ...) {
 
  dy <- args$dy
  ay <- args$ay

  stk <- window(stk, end=dy)

  if(all(is.na(harvest(stk))))
    harvest(stk) <- harvest(stock.n(stk), catch.n(stk), m(stk))
  
  track(tracking, "conv.est", ac(ay)) <- 1
  
  list(stk=stk, tracking=tracking)
}
# }}}

# shortcut.sa {{{

#' @examples
#' data(sol274)
#' #
#' stk <- window(stock(om), end=2018)
#' idx <- window(observations(oem)$idx, end=2018)
#' #
#' shortcut.sa(stk, idx, args=list(y0=1980, dy=2017, ay=2019, frq=1),
#'   devs=rlnormar1(100, sdlog=0.2, rho=0.5, years=1980:2017),
#'   tracking=FLQuant(dimnames=list(metric=c("conv.est"), year=2017:2019)))

shortcut.sa <- function(stk, idx, metric="ssb", SSBdevs=ind %=% 1, devs=SSBdevs,
  args, tracking, ...) {

  # DIMS
  y0 <- args$y0
  dy <- args$dy
  ay <- args$ay
  frq <- args$frq

  # SUBSET oem stock
  stk <- window(stk, end=dy)

  # COMPUTE 'metric'
  ind <- do.call(metric, c(list(stk), list(...)))
  ind <- FLQuants(ind * window(devs, start=y0, end=dy))

  # OUTPUT metric as ind
  names(ind) <- metric

  # TRACK 'convergence'
  track(tracking, "conv.est", ac(ay)) <- 1
 # track(tracking, "SB.ind", seq(ay, ay + frq - 1)) <-
 #   ind[[1]][, ac(seq(ay, ay + frq - 1))]

  list(stk=stk, ind=ind, tracking=tracking)
}

# }}}

# shortcut_devs {{{

shortcut_devs <- function(om, Fcv=0.212, Fphi=0.423, SSBcv=0, SSBphi=0,
  bias.correct=FALSE) {

  devs <- FLQuants(
    F=rlnormar1(n=dims(om)$iter, meanlog=0, sdlog=Fcv, rho=Fphi, 
      years=dimnames(om)$year, bias.correct=bias.correct),
    SSB=rlnormar1(n=dims(om)$iter, meanlog=0, sdlog=SSBcv, rho=0,
      years=dimnames(om)$year, bias.correct=bias.correct)
  )

  return(devs)
}
# }}}
